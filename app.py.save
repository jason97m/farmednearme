from flask import Flask, render_template, request
import csv
from math import radians, cos, sin, asin, sqrt
from geopy.geocoders import Nominatim
from geopy.exc import GeocoderTimedOut, GeocoderUnavailable

# -------------------------------------------------
# App setup
# -------------------------------------------------
app = Flask(__name__)

geolocator = Nominatim(
    user_agent="farmednearme (contact: jason.l.morris@gmail.com)",
    timeout=10
)

# Simple in-memory geocode cache
geocode_cache = {}

# -------------------------------------------------
# Utility functions
# -------------------------------------------------
def haversine(lat1, lon1, lat2, lon2):
    """Calculate distance between two lat/lon points in miles."""
    lon1, lat1, lon2, lat2 = map(radians, [lon1, lat1, lon2, lat2])
    dlon = lon2 - lon1
    dlat = lat2 - lat1
    a = sin(dlat / 2) ** 2 + cos(lat1) * cos(lat2) * sin(dlon / 2) ** 2
    c = 2 * asin(sqrt(a))
    return 3956 * c  # miles


def load_markets():
    """Load farmers markets from CSV."""
    markets = []
    with open("data/markets.csv", newline="", encoding="utf-8") as f:
        reader = csv.DictReader(f)
        for row in reader:
            try:
                row["lat"] = float(row["location_y"])
                row["lon"] = float(row["location_x"])
                markets.append(row)
            except (ValueError, KeyError):
                continue
    return markets


def geocode_location(location):
    """Geocode with caching and error handling."""
    if location in geocode_cache:
        return geocode_cache[location]

    try:
        geo = geolocator.geocode(location)
        geocode_cache[location] = geo
        return geo
    except (GeocoderTimedOut, GeocoderUnavailable):
        return None


# -------------------------------------------------
# Routes
# -------------------------------------------------
@app.route("/")
def index():
    return render_template("index.html")


@app.route("/search")
def search():
    location = request.args.get("location")

    if not location:
        return render_template(
            "results.html",
            error="Please enter a location."
        )

    geo = geocode_location(location)

    if not geo:
        return render_template(
            "results.html",
            error="Location not found or geocoding service unavailable.",
            location=location
        )

    markets = load_markets()
    results = []

    for m in markets:
        distance = haversine(
            geo.latitude,
            geo.longitude,
            m["lat"],
            m["lon"]
        )

        if distance <= 50:  # 50 mile radius
            m["distance"] = round(distance, 1)
            results.append(m)

    results.sort(key=lambda x: x["distance"])

    return render_template(
        "results.html",
        markets=results,
        location=location
    )


@app.route("/market/<listing_id>")
def market_detail(listing_id):
    markets = load_markets()
    market = next(
        (m for m in markets if m["listing_id"] == listing_id),
        None
    )

    if not market:
        return "Market not found", 404

    return render_template("market.html", market=market)


# -------------------------------------------------
# App entry point
# -------------------------------------------------
if __name__ == "__main__":
    app.run(debug=True)
